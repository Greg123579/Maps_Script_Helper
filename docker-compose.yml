services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: maps-python-backend
    ports:
      - "8000:8080"
    volumes:
      # Mount project directory for auto-reload
      - .:/app
      # Mount outputs directory (persist outputs)
      - ./outputs:/app/outputs
      # Mount library directory (persist library images)
      - ./library:/app/library
      # Mount assets directory
      - ./assets:/app/assets
      # Mount user_jobs.json (ensure it exists as a file before mounting)
      - ./user_jobs.json:/app/user_jobs.json
      # Mount deploy directory (where scripts will be deployed)
      - ./deploy:/deploy
      # Mount Docker socket so backend can spawn py-exec script containers
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - PYTHONUNBUFFERED=1
      - EXECUTION_RUNTIME=docker
      # Host path for Docker-in-Docker volume mounts (required for script execution)
      - HOST_PROJECT_DIR=${PWD}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - KUBERNETES_NAMESPACE=maps-data-analysis
      - RUNNER_IMAGE=py-exec:latest
      - SCRIPT_TIMEOUT=600
      - TZ=America/Los_Angeles
    restart: unless-stopped
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

