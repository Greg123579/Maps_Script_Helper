{
  "log_id": "c38321ea-a421-40f2-b152-56116e6a662f",
  "session_id": "c38321ea-a421-40f2-b152-56116e6a662f",
  "timestamp": "2025-12-21T11:55:59.942672",
  "status": "failed",
  "code": "# ======================================================================\r\n# AUTO-DEBUG MODE ACTIVE\r\n# Diagnostic logging has been automatically injected to help\r\n# identify the issue. This will be removed after successful execution.\r\n# ======================================================================\r\n\r\n# Last Code Update - 11:55:19\r\n# MAPS Script Bridge - False Color (Single Image)\r\n# Creates a single RGB color visualization using the viridis colormap.\r\n# Output: One color image (no independent channel control in Maps)\r\n# Use when: You want a quick color visualization or final composite\r\n\r\nimport os\r\nimport tempfile\r\nimport MapsBridge\r\nfrom PIL import Image\r\nimport numpy as np\r\nimport matplotlib.cm as cm\r\n\r\ndef main():\r\n    # 1. Get the script request from MAPS\r\n    request1 = MapsBridge.ScriptTileSetRequest.FromStdIn() # Renamed request1 to request for clarity\r\n    print(f\"[AUTO-DEBUG] MapsBridge request loaded: request1, type={type(request1)}\")\r\n    sourceTileSet = request.SourceTileSet\r\n    tileInfo = sourceTileSet.Tiles[0]\r\n    \r\n    # 2. Get input image filename for channel \"0\"\r\n    input_filename = tileInfo.ImageFileNames[\"0\"]\r\n    source_folder = sourceTileSet.DataFolderPath\r\n    input_path = os.path.join(source_folder, input_filename)\r\n    \r\n    # 3. Load the image and convert to grayscale, then to NumPy array\r\n    MapsBridge.LogInfo(f\"Loading: {input_path}\")\r\n    img = Image.open(input_path).convert(\"L\")  # Convert to grayscale\r\n    print(f\"[AUTO-DEBUG] Loaded image: img, mode={img.mode}, size={img.size}, dtype={type(img)}\")\r\n    gray_data = np.array(img)\r\n    \r\n    # 4. Apply the false color map\r\n    # Normalize the grayscale data to the 0.0-1.0 range\r\n    # This automatically handles both 8-bit and 16-bit images\r\n    MapsBridge.LogInfo(\"Applying 'viridis' colormap...\")\r\n    min_val = gray_data.min()\r\n    max_val = gray_data.max()\r\n    \r\n    if max_val > min_val:\r\n        normalized_data = (gray_data - min_val) / (max_val - min_val)\r\n    else:\r\n        # Handle solid color images to avoid division by zero\r\n        normalized_data = np.zeros_like(gray_data, dtype=float)\r\n\r\n    # Apply the 'viridis' colormap. The result is an RGBA array with float values.\r\n    colored_data = cm.viridis(normalized_data)\r\n    \r\n    # Convert from float RGBA (0.0-1.0) to uint8 RGB (0-255) for saving\r\n    rgb_array = (colored_data[:, :, :3] * 255).astype(np.uint8)\r\n    \r\n    # Convert the NumPy array back to a PIL Image\r\n    result_image = Image.fromarray(rgb_array)\r\n\r\n    # 5. Save output to a temporary folder\r\n    output_folder = os.path.join(tempfile.gettempdir(), \"false_color_output\")\r\n    os.makedirs(output_folder, exist_ok=True)\r\n    base, ext = os.path.splitext(input_filename)\r\n    output_path = os.path.join(output_folder, f\"{base}_color.png\")\r\n    result_image.save(output_path)\r\n    MapsBridge.LogInfo(f\"Saved false color image to: {output_path}\")\r\n    \r\n    # 6. Create the output tile set\r\n    outputTileSetInfo = MapsBridge.GetOrCreateOutputTileSet(\r\n        \"False Color \" + sourceTileSet.Name,\r\n        targetLayerGroupName=\"Outputs\"\r\n    )\r\n    outputTileSet = outputTileSetInfo.TileSet\r\n    \r\n    # 7. Create a channel for the colored output and send the result\r\n    MapsBridge.CreateChannel(\"Viridis\", (255, 255, 255), True, outputTileSet.Guid)\r\n    MapsBridge.SendSingleTileOutput(\r\n        tileInfo.Row, tileInfo.Column,\r\n        \"Viridis\", output_path, True, outputTileSet.Guid\r\n    )\r\n    \r\n    MapsBridge.LogInfo(\"Done!\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "1b6cd17b75d0dc35",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.tif",
  "error_message": "Script exited with code 2. Error: User code error: name 'request' is not defined\n[DEBUG] Full traceback:\nTraceback (most recent call last):\n  File \"/work/job_runner.py\", line 150, in main\n    exec(compile(src, str(code_path), \"exec\"),",
  "error_type": "NameError",
  "stderr": "User code error: name 'request' is not defined\n[DEBUG] Full traceback:\nTraceback (most recent call last):\n  File \"/work/job_runner.py\", line 150, in main\n    exec(compile(src, str(code_path), \"exec\"), user_globals, user_globals)\n  File \"/code/main.py\", line 85, in <module>\n    main()\n  File \"/code/main.py\", line 24, in main\n    sourceTileSet = request.SourceTileSet\n                    ^^^^^^^\nNameError: name 'request' is not defined\n",
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.png (is_file=True)\n[DEBUG]   - image.tif (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (3444 chars):\n----------------------------------------\n[DEBUG]   1: # ======================================================================\n[DEBUG]   2: # AUTO-DEBUG MODE ACTIVE\n[DEBUG]   3: # Diagnostic logging has been automatically injected to help\n[DEBUG]   4: # identify the issue. This will be removed after successful execution.\n[DEBUG]   5: # ======================================================================\n[DEBUG]   6: \n[DEBUG]   7: # Last Code Update - 11:55:19\n[DEBUG]   8: # MAPS Script Bridge - False Color (Single Image)\n[DEBUG]   9: # Creates a single RGB color visualization using the viridis colormap.\n[DEBUG]  10: # Output: One color image (no independent channel control in Maps)\n[DEBUG]  11: # Use when: You want a quick color visualization or final composite\n[DEBUG]  12: \n[DEBUG]  13: import os\n[DEBUG]  14: import tempfile\n[DEBUG]  15: import MapsBridge\n[DEBUG]  16: from PIL import Image\n[DEBUG]  17: import numpy as np\n[DEBUG]  18: import matplotlib.cm as cm\n[DEBUG]  19: \n[DEBUG]  20: def main():\n[DEBUG] ... (65 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 2\n[MapsBridge DEBUG] Extracted image metadata: 512x442, format=Gray8\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[AUTO-DEBUG] MapsBridge request loaded: request1, type=<class 'MapsBridge.ScriptTileSetRequest'>\n",
  "return_code": 2,
  "output_files": null,
  "execution_time_seconds": null,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": "unknown",
  "tags": [
    "lib:MapsBridge",
    "lib:numpy",
    "lib:matplotlib",
    "lib:PIL",
    "request_type:tileset",
    "output:tile",
    "output:channel"
  ]
}