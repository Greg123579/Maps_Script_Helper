{
  "log_id": "c613cbd1-024e-4832-9c31-cb078c81d67b",
  "session_id": "c613cbd1-024e-4832-9c31-cb078c81d67b",
  "timestamp": "2025-12-21T09:40:28.303619",
  "status": "success",
  "code": "# Last Code Update - 09:40:23\r\nimport os\r\nimport tempfile\r\nimport MapsBridge\r\nfrom PIL import Image\r\nimport pandas as pd\r\n\r\ndef main():\r\n    # 1. Get input\r\n    request = MapsBridge.ScriptTileSetRequest.FromStdIn()\r\n    sourceTileSet = request.SourceTileSet\r\n\r\n    # The original script used sourceTileSet.Tiles[0], which assumes only one tile.\r\n    # For robustness, we should iterate through TilesToProcess if provided,\r\n    # or handle the case where there might be multiple tiles in the input.\r\n    # For this example, we'll process the first tile in TilesToProcess.\r\n    if not request.TilesToProcess:\r\n        MapsBridge.LogError(\"No tiles to process found in the request.\")\r\n        return\r\n\r\n    tileInfo = request.TilesToProcess[0]\r\n    # Find the corresponding tile object from the sourceTileSet\r\n    tile = next((t for t in sourceTileSet.Tiles\r\n                 if t.Column == tileInfo.Column and t.Row == tileInfo.Row), None)\r\n\r\n    if not tile:\r\n        MapsBridge.LogError(f\"Could not find tile data for [{tileInfo.Column}, {tileInfo.Row}] in sourceTileSet.\")\r\n        return\r\n\r\n    # 2. Load image\r\n    # ðŸš¨ CRITICAL: Use STRING key \"0\" not integer 0\r\n    input_filename = tile.ImageFileNames[\"0\"]\r\n    input_path = os.path.join(sourceTileSet.DataFolderPath, input_filename)\r\n    \r\n    try:\r\n        img = Image.open(input_path)\r\n    except FileNotFoundError:\r\n        MapsBridge.LogError(f\"Input file not found: {input_path}\")\r\n        return\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error opening image file {input_path}: {e}\")\r\n        return\r\n\r\n    MapsBridge.LogInfo(f\"Processing: {input_filename} (Tile [{tile.Column}, {tile.Row}])\")\r\n\r\n    # 3. Save to temp (no processing of image content for this example)\r\n    # Use MapsBridge.GetTempOutputFolder for standardized temporary output locations\r\n    output_folder = MapsBridge.GetTempOutputFolder(\"copy_output\")\r\n    os.makedirs(output_folder, exist_ok=True)\r\n    output_image_path = os.path.join(output_folder, f\"tile_{tile.Column}_{tile.Row}.tif\") # Saving with tile info in name\r\n    \r\n    try:\r\n        img.save(output_image_path)\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error saving image to {output_image_path}: {e}\")\r\n        return\r\n\r\n    # 4. Create CSV output\r\n    csv_data = {\r\n        \"TileColumn\": [tile.Column],\r\n        \"TileRow\": [tile.Row],\r\n        \"InputFilename\": [input_filename],\r\n        \"OutputImagePath\": [os.path.basename(output_image_path)] # Store just the filename for clarity\r\n    }\r\n    df = pd.DataFrame(csv_data)\r\n    \r\n    output_csv_path = os.path.join(output_folder, f\"tile_{tile.Column}_{tile.Row}_info.csv\")\r\n    try:\r\n        df.to_csv(output_csv_path, index=False)\r\n        MapsBridge.LogInfo(f\"Saved CSV info to: {output_csv_path}\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error saving CSV to {output_csv_path}: {e}\")\r\n        return\r\n\r\n    # 5. Create output Tile Set if it doesn't exist\r\n    # Use GetDefaultOutputTileSetAndChannel for a more streamlined approach\r\n    outputInfo = MapsBridge.GetDefaultOutputTileSetAndChannel(\r\n        sourceTileSet=sourceTileSet,\r\n        channelName=\"Copy\",\r\n        channelColor=(255, 255, 255),\r\n        isAdditive=True,\r\n        targetLayerGroupName=\"Outputs\",\r\n    )\r\n    \r\n    # 6. Send output image\r\n    try:\r\n        MapsBridge.SendSingleTileOutput(\r\n            tile.Row, tile.Column,\r\n            \"Copy\", output_image_path, True, outputInfo.TileSet.Guid\r\n        )\r\n        MapsBridge.LogInfo(f\"Sent image output for tile [{tile.Column}, {tile.Row}]\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error sending single tile output for tile [{tile.Column}, {tile.Row}]: {e}\")\r\n        return\r\n\r\n    # 7. Optionally, store the CSV file as an artifact or send it as a separate output\r\n    # The CSV is saved to the temp output folder and its filename is logged.\r\n    # To make it an actual output that MAPS can track, we can use StoreFile.\r\n    try:\r\n        MapsBridge.StoreFile(\r\n            output_csv_path,\r\n            overwrite=True,\r\n            keepFile=True,\r\n            targetLayerGroupName=\"Outputs\", # Associate it with the output layer group\r\n            fileName=f\"tile_{tile.Column}_{tile.Row}_info.csv\" # Explicitly name the stored file\r\n        )\r\n        MapsBridge.LogInfo(f\"Stored CSV file as artifact: {os.path.basename(output_csv_path)}\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error storing CSV file as artifact: {e}\")\r\n        return\r\n\r\n    # Append notes about the processing\r\n    # The AppendNotes function does not take targetLayerGuid. It can be associated with a layer group.\r\n    # If you want to append notes to a specific tile in the output TileSet, you would typically do this\r\n    # via the SendSingleTileOutput function's 'notes' parameter or by managing it within the TileSet object.\r\n    # For general notes on the entire output TileSet, the targetLayerGroupName is used.\r\n    MapsBridge.AppendNotes(\r\n        f\"Image copied without modification. Info saved to: {os.path.basename(output_csv_path)}\",\r\n        targetLayerGroupName=\"Outputs\" \r\n    )\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "7dc3db4ac21fe1f5",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.jpg",
  "error_message": null,
  "error_type": null,
  "stderr": null,
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.jpg (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (5050 chars):\n----------------------------------------\n[DEBUG]   1: # Last Code Update - 09:40:23\n[DEBUG]   2: import os\n[DEBUG]   3: import tempfile\n[DEBUG]   4: import MapsBridge\n[DEBUG]   5: from PIL import Image\n[DEBUG]   6: import pandas as pd\n[DEBUG]   7: \n[DEBUG]   8: def main():\n[DEBUG]   9:     # 1. Get input\n[DEBUG]  10:     request = MapsBridge.ScriptTileSetRequest.FromStdIn()\n[DEBUG]  11:     sourceTileSet = request.SourceTileSet\n[DEBUG]  12: \n[DEBUG]  13:     # The original script used sourceTileSet.Tiles[0], which assumes only one tile.\n[DEBUG]  14:     # For robustness, we should iterate through TilesToProcess if provided,\n[DEBUG]  15:     # or handle the case where there might be multiple tiles in the input.\n[DEBUG]  16:     # For this example, we'll process the first tile in TilesToProcess.\n[DEBUG]  17:     if not request.TilesToProcess:\n[DEBUG]  18:         MapsBridge.LogError(\"No tiles to process found in the request.\")\n[DEBUG]  19:         return\n[DEBUG]  20: \n[DEBUG] ... (103 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 1\n[MapsBridge DEBUG] Extracted image metadata: 1024x496, format=Bgr24\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[INFO] Processing: image.jpg (Tile [1, 1])\n[INFO] Saved CSV info to: /tmp/copy_output/tile_1_1_info.csv\n[INFO] Created output tile set: Results for LocalTestTileSet (Guid: {B83AE12E-04EF-4DBC-8C76-01CE2376F8CC})\n[INFO] Created channel: Copy with color (255, 255, 255)\n[MapsBridge DEBUG] SendSingleTileOutput() called:\n[MapsBridge DEBUG]   tileRow=1, tileColumn=1\n[MapsBridge DEBUG]   targetChannelName='Copy'\n[MapsBridge DEBUG]   imageFilePath='/tmp/copy_output/tile_1_1.tif'\n[INFO] Output saved: Copy_tile_1_1.tif (Channel: Copy, Tile: [1, 1])\n[INFO] Sent image output for tile [1, 1]\n[DEBUG] User code execution completed successfully\n[DEBUG] Contents of /output AFTER script execution:\n[DEBUG]   - .matplotlib/ (directory)\n[DEBUG]   - Copy_tile_1_1.tif (1523852 bytes)\n[DEBUG] job_runner.py finished\n",
  "return_code": null,
  "output_files": [
    "Copy_tile_1_1.tif"
  ],
  "execution_time_seconds": 1.8433644771575928,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": null,
  "tags": [
    "lib:MapsBridge",
    "lib:PIL",
    "lib:pandas",
    "request_type:tileset",
    "output:tile"
  ]
}