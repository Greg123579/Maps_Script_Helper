{
  "log_id": "9413bebe-0a44-4321-ba21-7c133508e7ed",
  "session_id": "9413bebe-0a44-4321-ba21-7c133508e7ed",
  "timestamp": "2025-12-21T10:38:37.056518",
  "status": "success",
  "code": "# Last Code Update - 10:38:32\r\nimport os\r\nimport tempfile\r\nimport MapsBridge\r\nfrom PIL import Image\r\nimport pandas as pd\r\nimport numpy as np\r\n\r\ndef main():\r\n    # 1. Get input\r\n    request = MapsBridge.ScriptTileSetRequest.FromStdIn()\r\n    sourceTileSet = request.SourceTileSet\r\n    \r\n    # Assuming we are processing the first tile in the request for simplicity.\r\n    # In a real scenario, you might iterate through request.TilesToProcess.\r\n    if not request.TilesToProcess:\r\n        MapsBridge.LogError(\"No tiles to process were found in the request.\")\r\n        return\r\n    \r\n    tileInfo = request.TilesToProcess[0]\r\n    tile = next((t for t in sourceTileSet.Tiles \r\n                 if t.Column == tileInfo.Column and t.Row == tileInfo.Row), None)\r\n\r\n    if not tile:\r\n        MapsBridge.LogError(f\"Could not find tile details for [{tileInfo.Column}, {tileInfo.Row}].\")\r\n        return\r\n\r\n    # 2. Load image\r\n    # ðŸš¨ CRITICAL: Use STRING key \"0\" not integer 0\r\n    input_filename = tile.ImageFileNames.get(\"0\")\r\n    if not input_filename:\r\n        MapsBridge.LogError(f\"No image filename found for channel '0' on tile [{tile.Column}, {tile.Row}].\")\r\n        return\r\n\r\n    input_path = os.path.join(sourceTileSet.DataFolderPath, input_filename)\r\n    \r\n    try:\r\n        img = Image.open(input_path)\r\n        MapsBridge.LogInfo(f\"Processing: {input_filename}\")\r\n    except FileNotFoundError:\r\n        MapsBridge.LogError(f\"Input image not found at: {input_path}\")\r\n        return\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error opening image {input_path}: {e}\")\r\n        return\r\n    \r\n    # 3. Save to temp (no processing)\r\n    # Use MapsBridge.GetTempOutputFolder for consistency and better temp file management\r\n    output_folder = MapsBridge.GetTempOutputFolder(\"copy_output\")\r\n    output_path = os.path.join(output_folder, input_filename)\r\n    \r\n    try:\r\n        img.save(output_path)\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error saving image to {output_path}: {e}\")\r\n        return\r\n    \r\n    # 4. Create output tile set\r\n    outputTileSetInfo = MapsBridge.GetOrCreateOutputTileSet(\r\n        \"Copy of \" + sourceTileSet.Name,\r\n        targetLayerGroupName=\"Outputs\"\r\n    )\r\n    \r\n    # 5. Send output tile\r\n    # Ensure channel exists before sending output\r\n    MapsBridge.CreateChannel(\"Copy\", (255, 255, 255), True, outputTileSetInfo.TileSet.Guid)\r\n    MapsBridge.SendSingleTileOutput(\r\n        tileInfo.Row, tileInfo.Column,\r\n        \"Copy\", output_path, True, outputTileSetInfo.TileSet.Guid\r\n    )\r\n    \r\n    # Removed the problematic AppendNotes call.\r\n    # If you need to add descriptive text, consider adding it to the output tile set's description\r\n    # when creating it with GetOrCreateOutputTileSet, or as notes within StoreFile.\r\n\r\n    # --- CSV Report Generation ---\r\n    MapsBridge.LogInfo(\"Generating CSV report...\")\r\n\r\n    # Generate random data for the report\r\n    num_rows = 5\r\n    num_cols = 3\r\n    random_data = np.random.rand(num_rows, num_cols)\r\n    \r\n    # Create a DataFrame\r\n    df = pd.DataFrame(random_data, columns=[f'Col_{i+1}' for i in range(num_cols)])\r\n    df['Category'] = np.random.choice(['A', 'B', 'C'], size=num_rows)\r\n\r\n    # Define a path for the CSV report in the temp directory\r\n    report_filename = f\"report_tile_{tile.Column}_{tile.Row}.csv\"\r\n    # Use MapsBridge.GetTempOutputFolder for consistency\r\n    report_output_folder = MapsBridge.GetTempOutputFolder(\"reports\")\r\n    report_path = os.path.join(report_output_folder, report_filename)\r\n\r\n    # Save the DataFrame to CSV\r\n    try:\r\n        df.to_csv(report_path, index=False)\r\n        MapsBridge.LogInfo(f\"CSV report saved to: {report_path}\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error saving CSV report to {report_path}: {e}\")\r\n        return\r\n\r\n    # Store the CSV file as an attachment to the output tile set\r\n    try:\r\n        # The StoreFile function is used to attach files.\r\n        # You can add notes here directly if needed for this specific file.\r\n        MapsBridge.StoreFile(\r\n            report_path,\r\n            overwrite=True,\r\n            keepFile=True, # Keep the file after upload\r\n            targetLayerGuid=outputTileSetInfo.TileSet.Guid,\r\n            # If you want to add notes *specifically to this stored file*:\r\n            # notes=f\"CSV report for tile [{tile.Column}, {tile.Row}]. Image copied without modification.\" \r\n        )\r\n        MapsBridge.LogInfo(f\"CSV report '{report_filename}' attached to output tile set.\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error storing CSV report {report_path}: {e}\")\r\n        return\r\n\r\n    MapsBridge.LogInfo(\"Processing complete with CSV report!\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "7cc8e6093acc8bdd",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.tif",
  "error_message": null,
  "error_type": null,
  "stderr": null,
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.png (is_file=True)\n[DEBUG]   - image.tif (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (4625 chars):\n----------------------------------------\n[DEBUG]   1: # Last Code Update - 10:38:32\n[DEBUG]   2: import os\n[DEBUG]   3: import tempfile\n[DEBUG]   4: import MapsBridge\n[DEBUG]   5: from PIL import Image\n[DEBUG]   6: import pandas as pd\n[DEBUG]   7: import numpy as np\n[DEBUG]   8: \n[DEBUG]   9: def main():\n[DEBUG]  10:     # 1. Get input\n[DEBUG]  11:     request = MapsBridge.ScriptTileSetRequest.FromStdIn()\n[DEBUG]  12:     sourceTileSet = request.SourceTileSet\n[DEBUG]  13:     \n[DEBUG]  14:     # Assuming we are processing the first tile in the request for simplicity.\n[DEBUG]  15:     # In a real scenario, you might iterate through request.TilesToProcess.\n[DEBUG]  16:     if not request.TilesToProcess:\n[DEBUG]  17:         MapsBridge.LogError(\"No tiles to process were found in the request.\")\n[DEBUG]  18:         return\n[DEBUG]  19:     \n[DEBUG]  20:     tileInfo = request.TilesToProcess[0]\n[DEBUG] ... (102 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 2\n[MapsBridge DEBUG] Extracted image metadata: 512x442, format=Gray8\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[INFO] Processing: image.png\n[INFO] Created output tile set: Copy of LocalTestTileSet (Guid: {0932ED92-E500-488B-BDD8-408EF11BFA42})\n[INFO] Created channel: Copy with color (255, 255, 255)\n[MapsBridge DEBUG] SendSingleTileOutput() called:\n[MapsBridge DEBUG]   tileRow=1, tileColumn=1\n[MapsBridge DEBUG]   targetChannelName='Copy'\n[MapsBridge DEBUG]   imageFilePath='/tmp/copy_output/image.png'\n[INFO] Output saved: Copy_image.png (Channel: Copy, Tile: [1, 1])\n[INFO] Generating CSV report...\n[INFO] CSV report saved to: /tmp/reports/report_tile_1_1.csv\n[DEBUG] User code execution completed successfully\n[DEBUG] Contents of /output AFTER script execution:\n[DEBUG]   - .matplotlib/ (directory)\n[DEBUG]   - Copy_image.png (28402 bytes)\n[DEBUG] job_runner.py finished\n",
  "return_code": null,
  "output_files": [
    "Copy_image.png"
  ],
  "execution_time_seconds": 2.3440022468566895,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": null,
  "tags": [
    "lib:MapsBridge",
    "lib:numpy",
    "lib:PIL",
    "lib:pandas",
    "request_type:tileset",
    "output:tile",
    "output:channel"
  ]
}