{
  "log_id": "25e39ac5-afa2-4eac-943a-47a5bac22bf3",
  "session_id": "25e39ac5-afa2-4eac-943a-47a5bac22bf3",
  "timestamp": "2025-12-21T11:50:56.536425",
  "status": "success",
  "code": "# Last Code Update - 11:50:12\r\nimport os\r\nimport MapsBridge\r\nimport cv2\r\nimport numpy as np\r\nfrom skimage import filters, morphology, measure\r\nimport tempfile # Import tempfile for creating temporary directories\r\n\r\ndef main():\r\n    # 1. Read the Tile Set request from stdin\r\n    request = MapsBridge.ScriptTileSetRequest.FromStdIn()\r\n    sourceTileSet = request.SourceTileSet\r\n    \r\n    MapsBridge.LogInfo(f\"Processing Tile Set: {sourceTileSet.Name} with {len(request.TilesToProcess)} tiles to process.\")\r\n    \r\n    # 2. Iterate through each tile requested for processing\r\n    # MapsBridge.IterTilesToProcessWithPath provides tile, tileInfo, and input_path for each tile.\r\n    # We specify channelIndex=\"0\" to process the first channel.\r\n    for tile, tileInfo, input_path in MapsBridge.IterTilesToProcessWithPath(request, channelIndex=\"0\"):\r\n        \r\n        # --- Debugging: Check if input_path is valid before attempting to read ---\r\n        if not input_path or not os.path.exists(input_path):\r\n            MapsBridge.LogError(f\"Invalid or non-existent input path for tile [{tile.Column}, {tile.Row}]: {input_path}\")\r\n            continue # Skip to the next tile if the path is invalid\r\n        # --------------------------------------------------------------------\r\n            \r\n        MapsBridge.LogInfo(f\"Processing tile [{tile.Column}, {tile.Row}] from file: {os.path.basename(input_path)}\")\r\n        \r\n        particle_count = 0\r\n        try:\r\n            # 3. Load the image for the current tile using OpenCV\r\n            # Ensure the path is correct and the image can be read\r\n            # Use cv2.IMREAD_GRAYSCALE as we're assuming single-channel EM images or we only need one channel\r\n            img = cv2.imread(input_path, cv2.IMREAD_GRAYSCALE) \r\n            \r\n            # --- Debugging: Check if image was loaded successfully ---\r\n            if img is None:\r\n                MapsBridge.LogError(f\"Could not read image file or it's empty. Path: {input_path}\")\r\n                continue # Skip to the next tile if image loading fails\r\n            # ---------------------------------------------------------\r\n\r\n            MapsBridge.LogInfo(f\"Image loaded for tile [{tile.Column}, {tile.Row}]. Shape: {img.shape}, Dtype: {img.dtype}\")\r\n\r\n            # 4. Image Processing: Detect particles\r\n            \r\n            # Apply Gaussian blur to reduce noise\r\n            # Kernel size (5,5) is usually fine, sigmaX/sigmaY=0 means they are calculated from kernel size.\r\n            blurred_img = cv2.GaussianBlur(img, (5, 5), 0)\r\n            \r\n            # Threshold the image to create a binary mask.\r\n            # Otsu's method is often good for EM images as it automatically finds a threshold.\r\n            # It returns the threshold value and the thresholded image.\r\n            thresh_val, binary_mask = cv2.threshold(blurred_img, 0, 255, cv2.THRESH_BINARY + cv2.THRESH_OTSU)\r\n            \r\n            MapsBridge.LogInfo(f\"Applied Otsu's thresholding. Threshold value: {thresh_val:.2f}\")\r\n\r\n            # Optional: Clean up the mask using morphological operations\r\n            # These help remove very small noise specks and fill tiny holes that might not be particles.\r\n            # Adjust min_size and area_threshold based on typical particle sizes in your images.\r\n            # Smaller values are more sensitive.\r\n            min_particle_area = 64 # Example: minimum pixel area for a particle\r\n            binary_mask = morphology.remove_small_objects(binary_mask.astype(bool), min_size=min_particle_area) \r\n            binary_mask = morphology.remove_small_holes(binary_mask.astype(bool), area_threshold=min_particle_area)\r\n            \r\n            MapsBridge.LogInfo(f\"Applied morphological operations (min_size={min_particle_area}).\")\r\n\r\n            # 5. Particle Detection and Counting using scikit-image\r\n            # 'label' finds connected components (particles) and assigns a unique integer to each.\r\n            # 'connectivity=2' means 8-connectivity (pixels are connected if they share a corner or an edge).\r\n            # 'background=0' specifies that pixels with value 0 are considered background.\r\n            # 'return_num=True' makes the function return the number of labels found.\r\n            labeled_image, num_labels = measure.label(binary_mask, connectivity=2, background=0, return_num=True)\r\n            \r\n            # The 'num_labels' returned by measure.label when background=0 already represents the number of\r\n            # foreground objects (particles). It does not count the background.\r\n            particle_count = num_labels\r\n            \r\n            MapsBridge.LogInfo(f\"Tile [{tile.Column}, {tile.Row}] - Detected {particle_count} particles.\")\r\n            \r\n            # 6. Outputting Results\r\n            # We will store the count in a temporary text file and send it as an output for this tile.\r\n            \r\n            # Create a temporary output folder for this script's outputs.\r\n            # MapsBridge.GetTempOutputFolder creates a unique folder for each script run.\r\n            # Using tempfile.mkdtemp() can also be used if more control is needed.\r\n            # We will use MapsBridge.GetTempOutputFolder for consistency with MAPS Bridge API.\r\n            output_folder = MapsBridge.GetTempOutputFolder(\"particle_counts\")\r\n            \r\n            # Ensure the output folder exists\r\n            os.makedirs(output_folder, exist_ok=True)\r\n            \r\n            # Create a filename for the count for this specific tile\r\n            count_filename = f\"tile_{tile.Column}_{tile.Row}_count.txt\"\r\n            output_path = os.path.join(output_folder, count_filename)\r\n            \r\n            # Write the particle count to the text file\r\n            with open(output_path, \"w\") as f:\r\n                f.write(f\"Tile Column: {tile.Column}\\n\")\r\n                f.write(f\"Tile Row: {tile.Row}\\n\")\r\n                f.write(f\"Particle Count: {particle_count}\\n\")\r\n            \r\n            MapsBridge.LogInfo(f\"Particle count written to: {output_path}\")\r\n\r\n            # 7. Prepare output for MapsBridge\r\n            \r\n            # Get or create the output tile set to store results.\r\n            # This ensures that results are grouped under a logical layer in MAPS.\r\n            outputTileSetInfo = MapsBridge.GetOrCreateOutputTileSet(\r\n                f\"Particle Count for {sourceTileSet.Name}\", # Name of the output tile set\r\n                targetLayerGroupName=\"Analysis Outputs\"     # Group outputs under this layer name in MAPS\r\n            )\r\n            \r\n            # Create a channel within the output tile set to hold these count files.\r\n            # Channel names should be descriptive.\r\n            output_channel_name = \"ParticleCounts\"\r\n            \r\n            # MapsBridge.CreateChannel handles checking if the channel already exists, so it's safe to call.\r\n            MapsBridge.CreateChannel(\r\n                output_channel_name,\r\n                (0, 255, 0),  # Color for the channel (e.g., green)\r\n                True,         # isAdditive=True (typically for images, but acceptable here)\r\n                outputTileSetInfo.TileSet.Guid # The GUID of the output tile set\r\n            )\r\n            \r\n            # 8. Send the output file for the current tile\r\n            # MapsBridge.SendSingleTileOutput associates the result file with the specific tile.\r\n            MapsBridge.SendSingleTileOutput(\r\n                tileRow=tileInfo.Row,          # The row of the tile being processed\r\n                tileColumn=tileInfo.Column,    # The column of the tile being processed\r\n                targetChannelName=output_channel_name, # The channel created above\r\n                imageFilePath=output_path,     # The path to the result file (the count.txt)\r\n                keepFile=True,                 # Keep the file after sending to MAPS\r\n                targetTileSetGuid=outputTileSetInfo.TileSet.Guid # The GUID of the output tile set\r\n            )\r\n            \r\n            MapsBridge.LogInfo(f\"Sent particle count for tile [{tile.Column}, {tile.Row}] to channel '{output_channel_name}'.\")\r\n\r\n        except Exception as e:\r\n            # Use a more specific error message and include tile coordinates for better debugging\r\n            MapsBridge.LogError(f\"Error processing tile [{tile.Column}, {tile.Row}]: {e}\", exc_info=True) # exc_info=True logs the full traceback\r\n            # If an error occurs, no output file for this tile should be sent.\r\n            # The loop will continue to the next tile.\r\n\r\n    MapsBridge.LogInfo(\"All tiles processed. Particle count script finished.\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "63f1559949a95526",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.tif",
  "error_message": null,
  "error_type": null,
  "stderr": null,
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.png (is_file=True)\n[DEBUG]   - image.tif (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (8505 chars):\n----------------------------------------\n[DEBUG]   1: # Last Code Update - 11:50:12\n[DEBUG]   2: import os\n[DEBUG]   3: import MapsBridge\n[DEBUG]   4: import cv2\n[DEBUG]   5: import numpy as np\n[DEBUG]   6: from skimage import filters, morphology, measure\n[DEBUG]   7: import tempfile # Import tempfile for creating temporary directories\n[DEBUG]   8: \n[DEBUG]   9: def main():\n[DEBUG]  10:     # 1. Read the Tile Set request from stdin\n[DEBUG]  11:     request = MapsBridge.ScriptTileSetRequest.FromStdIn()\n[DEBUG]  12:     sourceTileSet = request.SourceTileSet\n[DEBUG]  13:     \n[DEBUG]  14:     MapsBridge.LogInfo(f\"Processing Tile Set: {sourceTileSet.Name} with {len(request.TilesToProcess)} tiles to process.\")\n[DEBUG]  15:     \n[DEBUG]  16:     # 2. Iterate through each tile requested for processing\n[DEBUG]  17:     # MapsBridge.IterTilesToProcessWithPath provides tile, tileInfo, and input_path for each tile.\n[DEBUG]  18:     # We specify channelIndex=\"0\" to process the first channel.\n[DEBUG]  19:     for tile, tileInfo, input_path in MapsBridge.IterTilesToProcessWithPath(request, channelIndex=\"0\"):\n[DEBUG]  20:         \n[DEBUG] ... (127 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 2\n[MapsBridge DEBUG] Extracted image metadata: 4096x3536, format=Gray8\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[INFO] Processing Tile Set: LocalTestTileSet with 1 tiles to process.\n[INFO] Processing tile [1, 1] from file: image.png\n[INFO] Image loaded for tile [1, 1]. Shape: (3536, 4096), Dtype: uint8\n[INFO] Applied Otsu's thresholding. Threshold value: 97.00\n[INFO] Applied morphological operations (min_size=64).\n[INFO] Tile [1, 1] - Detected 96 particles.\n[INFO] Particle count written to: /tmp/particle_counts/tile_1_1_count.txt\n[INFO] Created output tile set: Particle Count for LocalTestTileSet (Guid: {4FA6C253-0FB8-4D89-B1AA-43BAB43B002F})\n[INFO] Created channel: ParticleCounts with color (0, 255, 0)\n[MapsBridge DEBUG] SendSingleTileOutput() called:\n[MapsBridge DEBUG]   tileRow=1, tileColumn=1\n[MapsBridge DEBUG]   targetChannelName='ParticleCounts'\n[MapsBridge DEBUG]   imageFilePath='/tmp/particle_counts/tile_1_1_count.txt'\n[INFO] Output saved: ParticleCounts_tile_1_1_count.txt (Channel: ParticleCounts, Tile: [1, 1])\n[INFO] Sent particle count for tile [1, 1] to channel 'ParticleCounts'.\n[INFO] All tiles processed. Particle count script finished.\n[DEBUG] User code execution completed successfully\n[DEBUG] Contents of /output AFTER script execution:\n[DEBUG]   - .matplotlib/ (directory)\n[DEBUG]   - ParticleCounts_tile_1_1_count.txt (46 bytes)\n[DEBUG] job_runner.py finished\n",
  "return_code": null,
  "output_files": [
    "ParticleCounts_tile_1_1_count.txt"
  ],
  "execution_time_seconds": 6.815152406692505,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": null,
  "tags": [
    "lib:MapsBridge",
    "lib:numpy",
    "lib:skimage",
    "lib:cv2",
    "request_type:tileset",
    "output:tile",
    "output:channel"
  ]
}