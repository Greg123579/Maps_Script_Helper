{
  "log_id": "0c85b0c9-dd2a-4374-add4-7f9c0e9521a0",
  "session_id": "0c85b0c9-dd2a-4374-add4-7f9c0e9521a0",
  "timestamp": "2025-12-21T09:37:14.601201",
  "status": "success",
  "code": "# Last Code Update - 09:35:32\r\nimport os\r\nimport MapsBridge\r\nimport cv2\r\nimport numpy as np\r\nfrom skimage import measure\r\nimport pandas as pd # Import pandas\r\n\r\ndef main():\r\n    # 1. Read tile set request\r\n    request = MapsBridge.ScriptTileSetRequest.FromStdIn()\r\n    sourceTileSet = request.SourceTileSet\r\n    \r\n    # List to store data for the CSV report\r\n    report_data = [] \r\n    \r\n    # 2. Iterate through tiles to process\r\n    # ðŸš¨ CRITICAL: Channel index keys are strings: \"0\", \"1\", ...\r\n    for tile, tileInfo, input_path in MapsBridge.IterTilesToProcessWithPath(request, \"0\"):\r\n        MapsBridge.LogInfo(f\"Processing tile [{tile.Column}, {tile.Row}] from {os.path.basename(input_path)}\")\r\n        \r\n        particle_count = 0 # Initialize count for this tile\r\n\r\n        # 3. Process image\r\n        try:\r\n            img = cv2.imread(input_path, cv2.IMREAD_GRAYSCALE) # Read as grayscale\r\n            if img is None:\r\n                MapsBridge.LogWarning(f\"Could not read image: {input_path}\")\r\n                continue\r\n\r\n            # Apply Gaussian blur for noise reduction\r\n            blurred_img = cv2.GaussianBlur(img, (5, 5), 0)\r\n            \r\n            # Thresholding to create a binary image\r\n            _, binary_img = cv2.threshold(blurred_img, 150, 255, cv2.THRESH_BINARY)\r\n            \r\n            # Find connected components (particles)\r\n            num_labels, labeled_img, stats, centroids = cv2.connectedComponentsWithStats(binary_img, connectivity=8)\r\n\r\n            # Filter out the background component (label 0)\r\n            # Filter particles based on area (example: area > 50 pixels)\r\n            valid_particles = []\r\n            for i in range(1, num_labels):\r\n                area = stats[i][4] # stats[i][4] is the area\r\n                if area > 50:\r\n                    valid_particles.append(i)\r\n            \r\n            particle_count = len(valid_particles)\r\n\r\n            MapsBridge.LogInfo(f\"Tile [{tile.Column}, {tile.Row}] - Detected {particle_count} particles.\")\r\n\r\n            # Store data for the report\r\n            report_data.append({\r\n                'Tile_Row': tileInfo.Row,\r\n                'Tile_Column': tileInfo.Column,\r\n                'Particle_Count': particle_count\r\n            })\r\n\r\n            # 4. Create output for this tile (visualization image)\r\n            output_folder = MapsBridge.GetTempOutputFolder(\"particle_detection_outputs\")\r\n            tile_output_filename = f\"tile_{tile.Column}_{tile.Row}_detected.png\"\r\n            tile_output_path = os.path.join(output_folder, tile_output_filename)\r\n\r\n            output_img_display = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR) # Convert grayscale to BGR for color drawing\r\n\r\n            # Draw bounding boxes and centroids for valid particles\r\n            for i in valid_particles:\r\n                x, y, w, h, area = stats[i]\r\n                cx, cy = centroids[i]\r\n                cv2.rectangle(output_img_display, (x, y), (x + w, y + h), (0, 255, 0), 2) # Green bounding box\r\n                cv2.circle(output_img_display, (int(cx), int(cy)), 5, (0, 0, 255), -1) # Red centroid\r\n                cv2.putText(output_img_display, f\"ID:{i}\", (x, y - 5), cv2.FONT_HERSHEY_SIMPLEX, 0.5, (255, 255, 255), 1)\r\n\r\n            cv2.imwrite(tile_output_path, output_img_display)\r\n\r\n            # 5. Get or create output tile set and channel\r\n            outputInfo = MapsBridge.GetOrCreateOutputTileSet(\r\n                f\"Particle Detection - {sourceTileSet.Name}\",\r\n                targetLayerGroupName=\"Outputs\"\r\n            )\r\n\r\n            channel_name = \"Particle Detections\"\r\n            if not any(c.Name == channel_name for c in outputInfo.TileSet.Channels):\r\n                MapsBridge.CreateChannel(\r\n                    channel_name,\r\n                    (0, 255, 0),  # Green color for visualization\r\n                    False,       # Not additive\r\n                    outputInfo.TileSet.Guid\r\n                )\r\n            \r\n            # 6. Send output for this tile\r\n            MapsBridge.SendSingleTileOutput(\r\n                tileRow=tileInfo.Row,\r\n                tileColumn=tileInfo.Column,\r\n                targetChannelName=channel_name,\r\n                imageFilePath=tile_output_path,\r\n                keepFile=True,  # Keep the temporary output file\r\n                targetTileSetGuid=outputInfo.TileSet.Guid,\r\n            )\r\n            \r\n            # 7. Create annotation for the particle count per tile\r\n            stageCoords = MapsBridge.TileCenterToStage(tileInfo.Column, tileInfo.Row, sourceTileSet)\r\n            \r\n            MapsBridge.CreateAnnotation(\r\n                f\"Tile [{tile.Column},{tile.Row}] Particles: {particle_count}\",\r\n                stagePosition=(stageCoords.X, stageCoords.Y, 0),\r\n                targetLayerGroupName=\"Annotations\"\r\n            )\r\n\r\n        except Exception as e:\r\n            MapsBridge.LogError(f\"Error processing tile [{tile.Column}, {tile.Row}]: {e}\")\r\n\r\n    MapsBridge.LogInfo(\"Particle detection script finished processing all tiles.\")\r\n\r\n    # 8. Create and save the CSV report\r\n    if report_data:\r\n        report_df = pd.DataFrame(report_data)\r\n        \r\n        # Define the output path for the CSV report\r\n        # It's best to save this to the temporary output directory\r\n        output_folder = MapsBridge.GetTempOutputFolder(\"particle_detection_outputs\")\r\n        csv_report_path = os.path.join(output_folder, f\"particle_counts_{sourceTileSet.Name}.csv\")\r\n        \r\n        try:\r\n            report_df.to_csv(csv_report_path, index=False)\r\n            MapsBridge.LogInfo(f\"CSV report saved to: {csv_report_path}\")\r\n            \r\n            # Optional: Store the CSV report in MAPS as a file artifact\r\n            # This makes it easily accessible from the MAPS UI\r\n            # Get the output tile set GUID to associate the file with\r\n            outputInfo = MapsBridge.GetOrCreateOutputTileSet(\r\n                f\"Particle Detection - {sourceTileSet.Name}\",\r\n                targetLayerGroupName=\"Outputs\"\r\n            )\r\n            MapsBridge.StoreFile(\r\n                csv_report_path,\r\n                overwrite=True,\r\n                keepFile=True, # Keep the file in the temp directory after storing\r\n                targetLayerGuid=outputInfo.TileSet.Guid\r\n            )\r\n            MapsBridge.LogInfo(f\"CSV report stored in MAPS.\")\r\n\r\n        except Exception as e:\r\n            MapsBridge.LogError(f\"Failed to save or store CSV report: {e}\")\r\n    else:\r\n        MapsBridge.LogWarning(\"No particle data collected, CSV report will not be generated.\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "ceb514737feaa7a4",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.jpg",
  "error_message": null,
  "error_type": null,
  "stderr": null,
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.jpg (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (6461 chars):\n----------------------------------------\n[DEBUG]   1: # Last Code Update - 09:35:32\n[DEBUG]   2: import os\n[DEBUG]   3: import MapsBridge\n[DEBUG]   4: import cv2\n[DEBUG]   5: import numpy as np\n[DEBUG]   6: from skimage import measure\n[DEBUG]   7: import pandas as pd # Import pandas\n[DEBUG]   8: \n[DEBUG]   9: def main():\n[DEBUG]  10:     # 1. Read tile set request\n[DEBUG]  11:     request = MapsBridge.ScriptTileSetRequest.FromStdIn()\n[DEBUG]  12:     sourceTileSet = request.SourceTileSet\n[DEBUG]  13:     \n[DEBUG]  14:     # List to store data for the CSV report\n[DEBUG]  15:     report_data = [] \n[DEBUG]  16:     \n[DEBUG]  17:     # 2. Iterate through tiles to process\n[DEBUG]  18:     # ðŸš¨ CRITICAL: Channel index keys are strings: \"0\", \"1\", ...\n[DEBUG]  19:     for tile, tileInfo, input_path in MapsBridge.IterTilesToProcessWithPath(request, \"0\"):\n[DEBUG]  20:         MapsBridge.LogInfo(f\"Processing tile [{tile.Column}, {tile.Row}] from {os.path.basename(input_path)}\")\n[DEBUG] ... (130 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 1\n[MapsBridge DEBUG] Extracted image metadata: 1512x2016, format=Bgr24\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[INFO] Processing tile [1, 1] from image.jpg\n[INFO] Tile [1, 1] - Detected 279 particles.\n[INFO] Created output tile set: Particle Detection - LocalTestTileSet (Guid: {A559F328-CC4B-4AFA-B851-0F93355C718E})\n[INFO] Created channel: Particle Detections with color (0, 255, 0)\n[MapsBridge DEBUG] SendSingleTileOutput() called:\n[MapsBridge DEBUG]   tileRow=1, tileColumn=1\n[MapsBridge DEBUG]   targetChannelName='Particle Detections'\n[MapsBridge DEBUG]   imageFilePath='/tmp/particle_detection_outputs/tile_1_1_detected.png'\n[INFO] Output saved: Particle_Detections_tile_1_1_detected.png (Channel: Particle Detections, Tile: [1, 1])\n[INFO] Particle detection script finished processing all tiles.\n[INFO] CSV report saved to: /tmp/particle_detection_outputs/particle_counts_LocalTestTileSet.csv\n[MapsBridge DEBUG] Found existing tile set: Particle Detection - LocalTestTileSet\n[DEBUG] User code execution completed successfully\n[DEBUG] Contents of /output AFTER script execution:\n[DEBUG]   - .matplotlib/ (directory)\n[DEBUG]   - Particle_Detections_tile_1_1_detected.png (5070464 bytes)\n[DEBUG] job_runner.py finished\n",
  "return_code": null,
  "output_files": [
    "Particle_Detections_tile_1_1_detected.png"
  ],
  "execution_time_seconds": 2.3335821628570557,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": null,
  "tags": [
    "lib:MapsBridge",
    "lib:numpy",
    "lib:skimage",
    "lib:cv2",
    "lib:pandas",
    "request_type:tileset",
    "output:tile",
    "output:channel"
  ]
}