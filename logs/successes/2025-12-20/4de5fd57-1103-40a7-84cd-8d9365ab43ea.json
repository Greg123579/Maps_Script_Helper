{
  "log_id": "4de5fd57-1103-40a7-84cd-8d9365ab43ea",
  "session_id": "4de5fd57-1103-40a7-84cd-8d9365ab43ea",
  "timestamp": "2025-12-20T22:48:18.331303",
  "status": "success",
  "code": "# Last Code Update - 22:47:54\r\nimport os\r\nimport MapsBridge\r\nimport cv2\r\nimport numpy as np\r\n\r\ndef main():\r\n    # 1. Read tile set request\r\n    request = MapsBridge.ScriptTileSetRequest.FromStdIn()\r\n    sourceTileSet = request.SourceTileSet\r\n    \r\n    # 2. Get tile + TileInfo + input path (single-tile mode)\r\n    # ðŸš¨ CRITICAL: Channel index keys are strings: \"0\", \"1\", ...\r\n    tile, tileInfo, input_path = MapsBridge.ResolveSingleTileAndPath(request, \"0\")\r\n    \r\n    MapsBridge.LogInfo(f\"Processing tile [{tile.Column}, {tile.Row}] from {os.path.basename(input_path)}\")\r\n    \r\n    # 3. Process image: Histogram Equalization\r\n    try:\r\n        img = cv2.imread(input_path, cv2.IMREAD_COLOR) # Read as color image\r\n        if img is None:\r\n            raise FileNotFoundError(f\"Could not read image file: {input_path}\")\r\n\r\n        # Split channels for color image\r\n        channels = cv2.split(img)\r\n        equalized_channels = []\r\n        for channel in channels:\r\n            # Perform histogram equalization on each channel\r\n            equalized_channel = cv2.equalizeHist(channel)\r\n            equalized_channels.append(equalized_channel)\r\n        \r\n        # Merge channels back to form the color image\r\n        result = cv2.merge(equalized_channels)\r\n        \r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error processing image {input_path}: {e}\")\r\n        # You might want to decide how to handle errors: skip tile, save original, etc.\r\n        # For now, we'll log the error and exit this tile's processing.\r\n        return \r\n\r\n    # 4. Save to temp folder\r\n    output_folder = MapsBridge.GetTempOutputFolder(\"contrast_enhanced_tiles\")\r\n    output_filename = f\"enhanced_tile_{tile.Column}_{tile.Row}.tif\"\r\n    output_path = os.path.join(output_folder, output_filename)\r\n    \r\n    try:\r\n        cv2.imwrite(output_path, result)\r\n        MapsBridge.LogInfo(f\"Saved enhanced tile to: {output_path}\")\r\n    except Exception as e:\r\n        MapsBridge.LogError(f\"Error saving image {output_path}: {e}\")\r\n        return\r\n\r\n    # 5. Create/get output tile set and ensure channel exists\r\n    # Use GetDefaultOutputTileSetAndChannel for convenience\r\n    outputInfo = MapsBridge.GetDefaultOutputTileSetAndChannel(\r\n        sourceTileSet=sourceTileSet,\r\n        channelName=\"Contrast Enhanced\",\r\n        channelColor=(0, 255, 0), # Green color for this channel\r\n        isAdditive=True,\r\n        targetLayerGroupName=\"Processed Outputs\",\r\n    )\r\n    \r\n    # 6. Send output for the processed tile\r\n    MapsBridge.SendSingleTileOutput(\r\n        tileRow=tileInfo.Row,\r\n        tileColumn=tileInfo.Column,\r\n        targetChannelName=\"Contrast Enhanced\",\r\n        imageFilePath=output_path,\r\n        keepFile=True, # Keep the file in the temp folder so Maps can access it\r\n        targetTileSetGuid=outputInfo.TileSet.Guid,\r\n    )\r\n    \r\n    MapsBridge.LogInfo(f\"Processing complete for tile [{tile.Column}, {tile.Row}]!\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
  "code_hash": "22e4dca735dd16ec",
  "user_prompt": null,
  "ai_model": null,
  "image_filename": "image.tif",
  "error_message": null,
  "error_type": null,
  "stderr": null,
  "stdout": "============================================================\n[DEBUG] job_runner.py starting...\n[DEBUG] Python version: 3.11.14 (main, Dec  8 2025, 23:39:47) [GCC 14.2.0]\n[DEBUG] Working directory: /work\n[DEBUG] PYTHONPATH: /work\n============================================================\n[DEBUG] Checking /output directory...\n[DEBUG] /output exists\n[DEBUG] Contents of /output BEFORE script execution:\n[DEBUG]   - .matplotlib (is_file=False)\n[DEBUG] Contents of /input:\n[DEBUG]   - image.png (is_file=True)\n[DEBUG]   - image.tif (is_file=True)\n[DEBUG] Importing skimage and matplotlib...\n[DEBUG] Imports complete\n[DEBUG] Checking MapsBridge availability...\n[DEBUG] MapsBridge imported successfully from: /work/MapsBridge.py\n[DEBUG] main() starting...\n[DEBUG] Found code file: /code/main.py\n[DEBUG] Code to execute (2895 chars):\n----------------------------------------\n[DEBUG]   1: # Last Code Update - 22:47:54\n[DEBUG]   2: import os\n[DEBUG]   3: import MapsBridge\n[DEBUG]   4: import cv2\n[DEBUG]   5: import numpy as np\n[DEBUG]   6: \n[DEBUG]   7: def main():\n[DEBUG]   8:     # 1. Read tile set request\n[DEBUG]   9:     request = MapsBridge.ScriptTileSetRequest.FromStdIn()\n[DEBUG]  10:     sourceTileSet = request.SourceTileSet\n[DEBUG]  11:     \n[DEBUG]  12:     # 2. Get tile + TileInfo + input path (single-tile mode)\n[DEBUG]  13:     # ðŸš¨ CRITICAL: Channel index keys are strings: \"0\", \"1\", ...\n[DEBUG]  14:     tile, tileInfo, input_path = MapsBridge.ResolveSingleTileAndPath(request, \"0\")\n[DEBUG]  15:     \n[DEBUG]  16:     MapsBridge.LogInfo(f\"Processing tile [{tile.Column}, {tile.Row}] from {os.path.basename(input_path)}\")\n[DEBUG]  17:     \n[DEBUG]  18:     # 3. Process image: Histogram Equalization\n[DEBUG]  19:     try:\n[DEBUG]  20:         img = cv2.imread(input_path, cv2.IMREAD_COLOR) # Read as color image\n[DEBUG] ... (56 more lines)\n----------------------------------------\n[DEBUG] Executing user code...\n[DEBUG] __name__ set to: __main__\n[MapsBridge DEBUG] ScriptTileSetRequest.FromStdIn() called\n[MapsBridge DEBUG] Input directory: /input, exists: True\n[MapsBridge DEBUG] Total image files found: 2\n[MapsBridge DEBUG] Extracted image metadata: 4096x3536, format=Gray8\n[MapsBridge DEBUG] Created ScriptTileSetRequest with 1 tiles\n[INFO] Processing tile [1, 1] from image.png\n[INFO] Saved enhanced tile to: /tmp/contrast_enhanced_tiles/enhanced_tile_1_1.tif\n[INFO] Created output tile set: Results for LocalTestTileSet (Guid: {3746A3F3-32F3-4411-8604-43AE9F9D9969})\n[INFO] Created channel: Contrast Enhanced with color (0, 255, 0)\n[MapsBridge DEBUG] SendSingleTileOutput() called:\n[MapsBridge DEBUG]   tileRow=1, tileColumn=1\n[MapsBridge DEBUG]   targetChannelName='Contrast Enhanced'\n[MapsBridge DEBUG]   imageFilePath='/tmp/contrast_enhanced_tiles/enhanced_tile_1_1.tif'\n[INFO] Output saved: Contrast_Enhanced_enhanced_tile_1_1.tif (Channel: Contrast Enhanced, Tile: [1, 1])\n[INFO] Processing complete for tile [1, 1]!\n[DEBUG] User code execution completed successfully\n[DEBUG] Contents of /output AFTER script execution:\n[DEBUG]   - .matplotlib/ (directory)\n[DEBUG]   - Contrast_Enhanced_enhanced_tile_1_1.tif (16759598 bytes)\n[DEBUG] job_runner.py finished\n",
  "return_code": null,
  "output_files": [
    "Contrast_Enhanced_enhanced_tile_1_1.tif"
  ],
  "execution_time_seconds": 7.752756118774414,
  "previous_attempt_id": null,
  "fixed_by": null,
  "error_category": null,
  "tags": [
    "lib:MapsBridge",
    "lib:numpy",
    "lib:cv2",
    "request_type:tileset",
    "output:tile"
  ]
}